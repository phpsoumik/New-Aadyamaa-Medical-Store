<template>
    <section>
        <div class="app-container">
            <Toolbar>
                <template #start>
                    <Breadcrumb
                        :home="home"
                        :model="items"
                        class="p-menuitem-text p-p-1"
                    />
                </template>

                <template #end>
                    <div class="p-mx-2">
                        <Button
                            icon="pi pi-search"
                            class="p-button-primary px-4"
                            @click="openDialog"
                        />
                    </div>
                    <div class="p-mx-2">
                        <Button
                            label="Generate Reorder List"
                            icon="pi pi-list"
                            class="p-button-warning px-4"
                            @click="openReorderDialog"
                            :disabled="rList.length === 0"
                        />
                    </div>
                    <div class="">
                        <Button
                            icon="pi pi-file-excel"
                            class="p-button-success px-4"
                            @click="dt.exportCSV()"
                        />
                    </div>
                </template>
            </Toolbar>
            <div class="m-2 mt-4 mb-4 p-text-center">
                <h5>Stock Alert Report</h5>
                <p>{{ resultTitle }}</p>
            </div>
            <div class="p-mt-2">
                <DataTable
                    :value="rList"
                    :paginator="true"
                    :rows="100"
                    :rowsPerPageOptions="[50, 100, 200, 500]"
                    class="p-datatable-sm p-datatable-striped p-datatable-gridlines"
                    :resizableColumns="true"
                    :loading="loading"
                    :autoLayout="true"
                    responsiveLayout="scroll"
                    paginatorTemplate="FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} products"
                    :rowClass="getRowClass"
                    ref="dt"
                >
                    <template #empty>
                        <div class="p-text-center p-p-3">No records found</div>
                    </template>
                    <Column field="productName" header="Product Name"></Column>
                    <Column field="stripSize" header="Strip Size"> </Column>
                    <Column field="packSize" header="Pack Size"></Column>
                    <Column field="batchNo" header="Batch No"></Column>
                    <Column field="qty" header="Unit Qty"></Column>
                    <Column field="expiryDate" header="Expiry Date"></Column>
                    <Column
                        field="minStock"
                        header="Min Stock Require"
                    ></Column>
                    <Column
                        field="supplierName"
                        header="Supplier Name"
                    ></Column>
                    <Column header="Action">
                        <template #body="slotProps">
                            <Button
                                label="Generate Reorder"
                                icon="pi pi-shopping-cart"
                                class="p-button-sm p-button-warning"
                                @click="generateIndividualReorder(slotProps.data)"
                            />
                        </template>
                    </Column>
                </DataTable>
            </div>

            <Dialog
                v-model:visible="productDialog"
                :style="{ width: '50vw' }"
                :maximizable="true"
                position="top"
                class="p-fluid"
            >
                <template #header>
                    <h5 class="p-dialog-titlebar p-dialog-titlebar-icon">
                        <i class="pi pi-search" style="font-size: 1.2rem"></i>
                        {{ dialogTitle }}
                    </h5>
                </template>
                <div class="p-grid">
                    <div class="p-col">
                        <div class="p-field">
                            <label for="productName">Product Name</label>
                            <InputText
                                id="productName"
                                v-model="searchFilters.productName"
                                placeholder="Search by product name..."
                            />
                        </div>
                    </div>
                </div>
                <template #footer>
                    <Button
                        type="submit"
                        label="Search"
                        icon="pi pi-search"
                        class="p-button-primary"
                        @click="loadList"
                    />
                </template>
            </Dialog>

            <Dialog
                v-model:visible="reorderDialog"
                :style="{ width: '80vw' }"
                :maximizable="true"
                position="top"
                class="p-fluid"
            >
                <template #header>
                    <h5 class="p-dialog-titlebar p-dialog-titlebar-icon">
                        <i class="pi pi-list" style="font-size: 1.2rem"></i>
                        Supplier-wise Reorder List
                    </h5>
                </template>
                <div class="reorder-content" id="printableArea">
                    <div class="print-header">
                        <h2 class="shop-name">Aadyamaa Medical Shop</h2>
                        <p class="print-date">Date: {{ currentDateTime }}</p>
                    </div>
                    <div v-for="(products, supplier) in supplierGroups" :key="supplier" class="supplier-section">
                        <Panel :header="supplier + ' (' + products.length + ' products)'" :toggleable="true">
                            <DataTable :value="products" class="p-datatable-sm">
                                <Column field="productName" header="Product Name"></Column>
                                <Column field="batchNo" header="Batch No"></Column>
                                <Column field="qty" header="Current Qty">
                                    <template #body="slotProps">
                                        <span :class="getStockClass(slotProps.data)">{{ slotProps.data.qty }}</span>
                                    </template>
                                </Column>
                                <Column field="minStock" header="Min Stock"></Column>
                                <Column header="Reorder Qty" style="width: 150px;">
                                    <template #body="slotProps">
                                        <div class="reorder-qty-blank"></div>
                                    </template>
                                </Column>
                            </DataTable>
                        </Panel>
                    </div>
                </div>
                <template #footer>
                    <Button
                        label="Print"
                        icon="pi pi-print"
                        class="p-button-info"
                        @click="printReorderList"
                    />
                    <Button
                        label="Export to Excel"
                        icon="pi pi-file-excel"
                        class="p-button-success"
                        @click="exportReorderList"
                    />
                    <Button
                        label="Close"
                        icon="pi pi-times"
                        class="p-button-secondary"
                        @click="reorderDialog = false"
                    />
                </template>
            </Dialog>
        </div>
    </section>
</template>
<script lang="ts">
import { Options, mixins } from "vue-class-component";
import { ref } from "vue";
import StoreReports from "../../service/StoreReports";
import UtilityOptions from "../../mixins/UtilityOptions";

interface IReport {
    productName: string;
    packSize: string;
    stripSize: string;
    batchNo: string;
    qty: string;
    expiryDate: string;
    minStock: string;
    supplierName: string;
    reorderQty?: string;
}

@Options({
    title: 'Stock Alert Report',
    components: {},
})
export default class StockAlertReport extends mixins(UtilityOptions) {
    private dt = ref();
    private lists: IReport[] = [];
    private reportService;
    private resultTitle = "";
    private productDialog = false;
    private loading = false;
    private home = { icon: "pi pi-home", to: "/" };
    private items = [
        { label: "Reports", to: "reports" },
        { label: "Stock Alert Report", to: "stock-alert-report" },
    ];

    private searchFilters = {
        id: "",
        productName: "",
    };
    private dialogTitle;
    private submitted = false;
    private filterBranch = [];
    private reorderDialog = false;
    private supplierGroups: any = {};
    private selectedProduct: IReport | null = null;
    private currentDateTime = '';

    //CALLING WHENEVER COMPONENT LOADS
    created() {
        this.reportService = new StoreReports();
    }

    //CALLNING AFTER CONSTRUCTOR GET CALLED
    mounted() {
        this.storeList();
        this.loadList();
    }

    //OPEN DIALOG TO ADD NEW ITEM
    openDialog() {
        this.submitted = false;
        this.dialogTitle = "Filter Report";
        this.productDialog = true;
    }

    storeList() {
        this.reportService.getFilterList().then((res) => {
            this.filterBranch = res.stores;
        });
    }

    // USED TO GET SEARCHED ASSOCIATE
    loadList() {
        this.loading = true;
        this.reportService.stockAlertReport(this.searchFilters).then((res) => {
            if (res && res.record) {
                const data = this.camelizeKeys(res);
                this.resultTitle = data.resultTitle || '';
                this.lists = data.record || [];
            } else {
                this.resultTitle = 'No records found';
                this.lists = [];
            }
            this.loading = false;
        }).catch((error) => {
            console.error('Error loading stock alert report:', error);
            this.resultTitle = 'Error loading data';
            this.lists = [];
            this.loading = false;
        });
        this.productDialog = false;
    }

    get rList() {
        const l: IReport[] = [];

        this.lists.forEach((e) => {
            e.expiryDate = this.formatDate(e.expiryDate);
            l.push(e);
        });

        return l;
    }

    getRowClass(data: IReport) {
        const qty = parseFloat(data.qty) || 0;
        const minStock = parseFloat(data.minStock) || 0;
        
        if (qty === 0) {
            return 'stock-critical';
        } else if (qty <= minStock / 2) {
            return 'stock-danger';
        } else if (qty <= minStock) {
            return 'stock-warning';
        }
        return '';
    }

    openReorderDialog() {
        this.supplierGroups = {};
        
        this.rList.forEach((product: IReport) => {
            const supplier = product.supplierName || 'Unknown Supplier';
            if (!this.supplierGroups[supplier]) {
                this.supplierGroups[supplier] = [];
            }
            this.supplierGroups[supplier].push(product);
        });
        
        this.reorderDialog = true;
    }

    generateIndividualReorder(product: IReport) {
        this.selectedProduct = product;
        this.supplierGroups = {};
        
        const supplier = product.supplierName || 'Unknown Supplier';
        const productWithReorder = { ...product, reorderQty: '' };
        this.supplierGroups[supplier] = [productWithReorder];
        
        this.updateDateTime();
        this.reorderDialog = true;
    }

    updateDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString('en-GB');
        const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        this.currentDateTime = `${date} ${time}`;
    }

    printReorderList() {
        const printContent = document.getElementById('printableArea');
        if (!printContent) return;
        
        const printWindow = window.open('', '', 'height=600,width=800');
        if (!printWindow) return;
        
        printWindow.document.write('<html><head><title>Reorder List</title>');
        printWindow.document.write('<style>');
        printWindow.document.write(`
            body { font-family: Arial, sans-serif; padding: 20px; }
            .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
            .shop-name { font-size: 24px; font-weight: bold; margin: 0; color: #333; }
            .print-date { font-size: 14px; margin: 5px 0; color: #666; }
            .supplier-section { margin-bottom: 30px; page-break-inside: avoid; }
            h3 { background-color: #f0f0f0; padding: 10px; margin: 10px 0; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #4CAF50; color: white; }
            .reorder-qty-blank { min-height: 30px; border-bottom: 1px solid #333; }
            @media print {
                .no-print { display: none; }
                body { margin: 0; }
            }
        `);
        printWindow.document.write('</style></head><body>');
        printWindow.document.write(printContent.innerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.focus();
        
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    }

    calculateReorderQty(product: IReport) {
        const qty = parseFloat(product.qty) || 0;
        const minStock = parseFloat(product.minStock) || 0;
        const reorderQty = Math.max(0, minStock - qty + minStock * 0.2);
        return Math.ceil(reorderQty);
    }

    getStockClass(product: IReport) {
        const qty = parseFloat(product.qty) || 0;
        if (qty === 0) return 'text-danger font-weight-bold';
        return '';
    }

    exportReorderList() {
        let csvContent = 'Supplier,Product Name,Batch No,Current Qty,Min Stock,Reorder Qty\n';
        
        Object.keys(this.supplierGroups).forEach(supplier => {
            this.supplierGroups[supplier].forEach((product: IReport) => {
                const reorderQty = product.reorderQty || '';
                csvContent += `"${supplier}","${product.productName}","${product.batchNo}",${product.qty},${product.minStock},${reorderQty}\n`;
            });
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'supplier_reorder_list_' + new Date().getTime() + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
</script>

<style scoped>
::v-deep(.stock-critical) {
    background-color: #ff4444 !important;
    color: white !important;
    font-weight: bold;
}

::v-deep(.stock-danger) {
    background-color: #ff6b6b !important;
    color: white !important;
}

::v-deep(.stock-warning) {
    background-color: #fff3cd !important;
    color: #856404 !important;
}

::v-deep(.stock-critical:hover),
::v-deep(.stock-danger:hover),
::v-deep(.stock-warning:hover) {
    opacity: 0.9;
}

.reorder-content {
    max-height: 60vh;
    overflow-y: auto;
}

.supplier-section {
    margin-bottom: 1rem;
}

.text-primary {
    color: #007bff;
    font-weight: bold;
}

.text-danger {
    color: #dc3545;
}

.font-weight-bold {
    font-weight: bold;
}

.reorder-qty-blank {
    min-height: 30px;
    border-bottom: 1px solid #dee2e6;
    width: 100%;
}

.print-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #333;
}

.shop-name {
    font-size: 24px;
    font-weight: bold;
    margin: 0;
    color: #333;
}

.print-date {
    font-size: 14px;
    margin: 5px 0;
    color: #666;
}

@media print {
    .print-header {
        display: block !important;
    }
}
</style>
